<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Hoopers üèÄüêæ</title>
  <style>
    :root{
      --bg:#f8fafc;
      --text:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --border:#e2e8f0;
      --btn:#0f172a;
      --btnText:#ffffff;
      --success:#15803d;
    }
    *{ box-sizing:border-box; }

    body{
      margin:20px;
      font-family: Inter, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1280px;
      margin:0 auto;
    }

    /* Centered heading area */
    .hero{
      text-align:center;
      margin:0 0 18px;
    }

    h1{
      margin:0;
      font-size:56px;
      line-height:1.05;
      letter-spacing:-0.02em;
    }

    .sub{
      margin:8px 0 0;
      color:#334155;
      font-size:18px;
    }

    /* Force 4 per row on desktop */
    .grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:14px;
      align-items:stretch;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .card img{
      width:100%;
      aspect-ratio:4/3;
      object-fit:cover;
      display:block;
      object-position:center 35%;
      background:#e2e8f0;
    }

    .meta{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:150px;
    }

    .title{
      font-size:17px;
      font-weight:800;
      line-height:1.2;
    }

    .caption{
      font-size:14px;
      color:#334155;
      line-height:1.35;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:38px;
    }

    .vote-row{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .vote-btn{
      border:1px solid #cbd5e1;
      border-radius:9px;
      background:var(--btn);
      color:var(--btnText);
      padding:7px 12px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
    }
    .vote-btn:hover{ opacity:.95; }
    .vote-btn:disabled{ opacity:.7; cursor:not-allowed; }

    .vote-hint{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:150px;
      text-align:right;
    }

    .vote-success{
      margin-top:6px;
      font-size:12px;
      color:var(--success);
      font-weight:600;
      line-height:1.3;
    }

    .status{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
      white-space:pre-wrap;
    }

    /* Responsive breakpoints */
    @media (max-width:1100px){
      .grid{ grid-template-columns:repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width:820px){
      h1{ font-size:42px; }
      .sub{ font-size:16px; }
      .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width:520px){
      .grid{ grid-template-columns:1fr; }
      .vote-hint{ display:none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Mini Hoopers üèÄüêæ</h1>
      <p class="sub">Vote for your favorite approved entry.</p>
    </div>

    <div id="gallery" class="grid"></div>
    <div id="status" class="status">Loading entries...</div>
  </div>

  <script>
    // Approved Entries published CSV endpoint
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFX7nWMq_3plmeprD6ncT1UQA1BiUYwjdh2SSnKstU3FSPKILos79nA-SAYddYV_gt2iyslYqqMWp2/pub?gid=1795204638&single=true&output=csv";

    const LOCAL_PENDING_VOTE_KEY = "mini_hoopers_pending_vote";
    let allRows = [];

    function esc(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function parseCSV(text) {
      const s = String(text || "").replace(/^\uFEFF/, "");
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i=0; i<s.length; i++){
        const ch = s[i], next = s[i+1];
        if (ch === '"'){
          if (inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && ch === ','){ row.push(cur); cur=""; continue; }
        if (!inQuotes && ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; continue; }
        if (!inQuotes && ch === '\r') continue;
        cur += ch;
      }
      row.push(cur);
      rows.push(row);

      while (rows.length && rows[rows.length - 1].every(c => String(c || "").trim() === "")) rows.pop();
      return rows.map(r => r.map(c => String(c || "").trim()));
    }

    function findCol(headers, names){
      const lower = headers.map(h => String(h || "").trim().toLowerCase());
      for (const n of names){
        const i = lower.indexOf(String(n).toLowerCase());
        if (i !== -1) return i;
      }
      return -1;
    }

    function toDirectImageUrl(url){
      if (!url) return "";
      const u = String(url).trim();

      let m = u.match(/drive\.google\.com\/file\/d\/([^/]+)/i);
      if (m && m[1]) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

      m = u.match(/[?&]id=([^&]+)/i);
      if (m && m[1] && u.includes("drive.google.com")) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

      return u;
    }

    function validImageUrl(url){ return /^https?:\/\/.+/i.test(url); }

    function setPendingVote(entryId){ localStorage.setItem(LOCAL_PENDING_VOTE_KEY, entryId); }
    function getPendingVote(){ return localStorage.getItem(LOCAL_PENDING_VOTE_KEY) || ""; }

    function render(rows){
      const gallery = document.getElementById("gallery");
      const status = document.getElementById("status");
      const pending = getPendingVote();

      gallery.innerHTML = "";

      rows.forEach(item => {
        const selected = pending === item.id;

        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          <img loading="lazy" src="${esc(item.image_url)}" alt="${esc(item.id || "Mini Hooper")}" />
          <div class="meta">
            <div class="title">${esc(item.id || "Mini Hooper")}</div>
            <div class="caption" title="${esc(item.caption || "")}">${esc(item.caption || "")}</div>
            <div class="vote-row">
              <button class="vote-btn" data-id="${esc(item.id)}" ${selected ? "disabled" : ""}>
                ${selected ? "Submitted ‚úÖ" : "Vote"}
              </button>
              <span class="vote-hint">${selected ? "Vote recorded" : "One selection"}</span>
            </div>
            ${selected ? `<div class="vote-success">Your vote has been submitted.</div>` : ""}
          </div>
        `;

        const btn = card.querySelector(".vote-btn");
        btn.addEventListener("click", () => {
          setPendingVote(item.id);
          render(rows);
        });

        gallery.appendChild(card);
      });

      status.textContent = `Showing ${rows.length} approved entries.`;
    }

    async function load(){
      const status = document.getElementById("status");
      try{
        const res = await fetch(CSV_URL + "&_=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error(`CSV HTTP ${res.status}`);

        const csv = await res.text();
        const rows = parseCSV(csv);
        if (!rows || rows.length < 2) throw new Error("CSV contains no data rows.");

        const headers = rows[0];
        const idxCaption = findCol(headers, ["Caption"]);
        const idxImg = findCol(headers, ["Post Img URLs","Post Img URL","Postimg URLs","Postimg URL"]);
        const idxTitle = findCol(headers, ["Approved Mini Hoopers","Approved Mini Hooper"]);

        if (idxCaption === -1 || idxImg === -1 || idxTitle === -1) {
          throw new Error("Missing required columns: Caption, Post Img URLs, Approved Mini Hoopers.");
        }

        allRows = rows.slice(1).map((r, i) => {
          const row = r.slice();
          while (row.length < headers.length) row.push("");

          const caption = (row[idxCaption] || "").trim();
          const rawImg  = (row[idxImg] || "").trim();
          const id      = (row[idxTitle] || "").trim() || `Mini-Hooper ${i + 1}`;

          return { id, image_url: toDirectImageUrl(rawImg), caption };
        }).filter(x => x.id && validImageUrl(x.image_url));

        render(allRows);
      } catch(err){
        console.error(err);
        status.textContent = `Failed to load entries.\n${err.message}`;
      }
    }

    load();
  </script>
</body>
</html>
