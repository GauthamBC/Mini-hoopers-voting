<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Hoopers Voting</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f8fafc; color:#0f172a; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0 0 6px; font-size: 48px; line-height: 1.05; }
    .sub { color: #475569; margin: 0 0 16px; font-size: 20px; }
    .toolbar { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
    input[type="search"]{
      width: 420px; max-width: 100%;
      padding: 12px 14px; border:1px solid #cbd5e1; border-radius:12px; font-size: 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(250px,1fr));
      gap:16px;
    }
    .card{
      background:#fff; border:1px solid #e2e8f0; border-radius:14px; overflow:hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .card img{
      width:100%; height:230px; object-fit:cover; display:block; background:#e2e8f0;
    }
    .meta{ padding:12px; }
    .title{ font-weight:700; margin-bottom:8px; color:#0f172a; font-size: 18px; }
    .caption{ color:#334155; line-height:1.45; font-size:15px; margin-bottom: 12px; }
    .vote-btn{
      width:100%;
      border:1px solid #cbd5e1; border-radius:10px;
      background:#0f172a; color:#fff; padding:10px 12px; cursor:pointer; font-weight:700;
    }
    .vote-btn:disabled { opacity: .6; cursor:not-allowed; }
    .status{ margin-top:14px; color:#64748b; font-size:14px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mini Hoopers üèÄüêæ</h1>
    <p class="sub">Live gallery from the ‚ÄúApproved Entries‚Äù tab.</p>

    <div class="toolbar">
      <input id="search" type="search" placeholder="Search by name or caption..." />
    </div>

    <div id="gallery" class="grid"></div>
    <div id="status" class="status">Loading entries...</div>
  </div>
  <script>
  // IMPORTANT: use your real spreadsheet ID from /d/<ID>/edit
  // and your Approved Entries gid
  const FEED_URL = "https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/gviz/tq?tqx=out:json&gid=1795204638";

  let allRows = [];

  function extractGvizJson(text) {
    // Detect HTML responses (wrong URL/permissions/redirect)
    const t = text.trim();
    if (t.startsWith("<!DOCTYPE html") || t.startsWith("<html")) {
      throw new Error("Feed returned HTML, not GViz JSON. Check FEED_URL, publish settings, and sheet ID.");
    }

    // Preferred parse: wrapped callback format
    const match = t.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?\s*$/);
    if (match && match[1]) return JSON.parse(match[1]);

    // Fallback parse: first {...} block
    const start = t.indexOf("{");
    const end = t.lastIndexOf("}");
    if (start === -1 || end === -1 || end <= start) {
      throw new Error("Could not find JSON object in GViz response.");
    }
    return JSON.parse(t.slice(start, end + 1));
  }

  function esc(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Your columns:
  // F = index 5 (Caption)
  // H = index 7 (Post Img URLs)
  // I = index 8 (Approved Mini Hoopers)
  function mapRow(r){
    const c = r.c || [];
    return {
      caption: c[5]?.v ? String(c[5].v).trim() : "",
      image_url: c[7]?.v ? String(c[7].v).trim() : "",
      id: c[8]?.v ? String(c[8].v).trim() : ""
    };
  }

  function validImageUrl(url){
    return /^https?:\/\/.+/i.test(url);
  }

  function render(rows){
    const gallery = document.getElementById("gallery");
    const status = document.getElementById("status");
    gallery.innerHTML = "";

    rows.forEach(item => {
      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <img loading="lazy" src="${esc(item.image_url)}" alt="${esc(item.id || "Mini Hooper")}" />
        <div class="meta">
          <div class="title">${esc(item.id || "Mini Hooper")}</div>
          <div class="caption">${esc(item.caption || "")}</div>
        </div>
      `;
      gallery.appendChild(card);
    });

    status.textContent = `Showing ${rows.length} approved entries.`;
  }

  function applyFilter(){
    const q = document.getElementById("search").value.trim().toLowerCase();
    if(!q) return render(allRows);

    const filtered = allRows.filter(x =>
      (x.id || "").toLowerCase().includes(q) ||
      (x.caption || "").toLowerCase().includes(q)
    );
    render(filtered);
  }

  async function load(){
    const status = document.getElementById("status");
    try{
      const res = await fetch(FEED_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Feed HTTP ${res.status}`);

      const txt = await res.text();
      const data = extractGvizJson(txt);

      const raw = data?.table?.rows || [];
      allRows = raw.map(mapRow).filter(x => x.id && x.image_url && validImageUrl(x.image_url));

      render(allRows);
    } catch (e) {
      console.error(e);
      status.textContent = `Failed to load entries.\n${e.message}`;
    }
  }

  document.getElementById("search").addEventListener("input", applyFilter);
  load();
</script>
</body>
</html>
