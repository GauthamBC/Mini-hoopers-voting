<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Hoopers Voting</title>
  <style>
    :root{
      --bg:#f8fafc;
      --text:#0f172a;
      --muted:#475569;
      --card:#fff;
      --border:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{
      margin:24px;
      font-family:Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto}
    h1{margin:0 0 6px;font-size:42px;line-height:1.05}
    .sub{margin:0 0 16px;color:var(--muted);font-size:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    input[type="search"]{
      width:420px;max-width:100%;
      border:1px solid #cbd5e1;border-radius:12px;
      padding:12px 14px;font-size:16px
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
      gap:16px
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;overflow:hidden;
      box-shadow:0 1px 2px rgba(0,0,0,.04)
    }
    .card img{
      width:100%;height:230px;object-fit:cover;display:block;background:#e2e8f0
    }
    .meta{padding:12px}
    .title{font-weight:700;font-size:18px;margin-bottom:8px}
    .caption{font-size:14px;line-height:1.45;color:#334155}
    .status{margin-top:14px;font-size:14px;color:#64748b;white-space:pre-wrap}
    .debug{margin-top:6px;font-size:12px;color:#94a3b8;word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mini Hoopers üèÄüêæ</h1>
    <p class="sub">Live gallery from the ‚ÄúApproved entries‚Äù tab.</p>

    <div class="toolbar">
      <input id="search" type="search" placeholder="Search by name or caption..." />
    </div>

    <div id="gallery" class="grid"></div>
    <div id="status" class="status">Loading entries...</div>
    <div id="debug" class="debug"></div>
  </div>

<script>
  const FEED_URL = "https://docs.google.com/spreadsheets/d/REAL_SHEET_ID/gviz/tq?tqx=out:json&gid=1795204638";
  let allRows = [];

  function esc(s){
    return String(s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function extractGvizJson(text){
    const t = (text || "").trim();

    if (t.startsWith("<!DOCTYPE html") || t.startsWith("<html")) {
      throw new Error("Got HTML instead of GViz JSON. Check sheet ID, sharing, and gid.");
    }

    const m = t.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?\s*$/);
    if (m && m[1]) return JSON.parse(m[1]);

    const start = t.indexOf("{");
    const end = t.lastIndexOf("}");
    if (start === -1 || end === -1 || end <= start) {
      throw new Error("Could not parse GViz response.");
    }
    return JSON.parse(t.slice(start, end + 1));
  }

  // F=5 Caption, H=7 Post Img URLs, I=8 Approved Mini Hoopers
  function mapRow(r){
    const c = r.c || [];
    return {
      caption: c[5]?.v ? String(c[5].v).trim() : "",
      image_url: c[7]?.v ? String(c[7].v).trim() : "",
      id: c[8]?.v ? String(c[8].v).trim() : ""
    };
  }

  function validImageUrl(url){
    return /^https?:\/\/.+/i.test(url);
  }

  function render(rows){
    const gallery = document.getElementById("gallery");
    const status = document.getElementById("status");
    gallery.innerHTML = "";

    rows.forEach(item => {
      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <img loading="lazy" src="${esc(item.image_url)}" alt="${esc(item.id || "Mini Hooper")}" />
        <div class="meta">
          <div class="title">${esc(item.id || "Mini Hooper")}</div>
          <div class="caption">${esc(item.caption || "")}</div>
        </div>
      `;
      gallery.appendChild(card);
    });

    status.textContent = `Showing ${rows.length} approved entries.`;
  }

  function applyFilter(){
    const q = document.getElementById("search").value.trim().toLowerCase();
    if(!q) return render(allRows);

    const filtered = allRows.filter(x =>
      (x.id || "").toLowerCase().includes(q) ||
      (x.caption || "").toLowerCase().includes(q)
    );
    render(filtered);
  }

  async function load(){
    const status = document.getElementById("status");
    const debug = document.getElementById("debug");

    try{
      debug.textContent = `Feed URL: ${FEED_URL}`;
      const res = await fetch(FEED_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Feed HTTP ${res.status}`);

      const txt = await res.text();
      const data = extractGvizJson(txt);

      allRows = (data?.table?.rows || [])
        .map(mapRow)
        .filter(x => x.id && x.image_url && validImageUrl(x.image_url));

      render(allRows);
    } catch (err) {
      console.error(err);
      status.textContent = `Failed to load entries.\n${err.message}`;
    }
  }

  document.getElementById("search").addEventListener("input", applyFilter);
  load();
</script>
</body>
</html>
